From ca67a2f57c11a0c15b32426e721999e94518468b Mon Sep 17 00:00:00 2001
From: coduz <alberto.codutti@eurotech.com>
Date: Mon, 26 Aug 2019 17:32:57 +0200
Subject: [PATCH] Added configuration parameter to improve misfired trigger
 handling

Signed-off-by: coduz <alberto.codutti@eurotech.com>
---
 .../quartz/driver/QuartzTriggerDriver.java          | 13 +++++++++++--
 .../quartz/src/main/resources/quartz.properties     |  5 +++++
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/service/scheduler/quartz/src/main/java/org/eclipse/kapua/service/scheduler/quartz/driver/QuartzTriggerDriver.java b/service/scheduler/quartz/src/main/java/org/eclipse/kapua/service/scheduler/quartz/driver/QuartzTriggerDriver.java
index f4c0b3824d9..b96b93a683c 100644
--- a/service/scheduler/quartz/src/main/java/org/eclipse/kapua/service/scheduler/quartz/driver/QuartzTriggerDriver.java
+++ b/service/scheduler/quartz/src/main/java/org/eclipse/kapua/service/scheduler/quartz/driver/QuartzTriggerDriver.java
@@ -116,7 +116,11 @@ public static void createIntervalJobTrigger(@NotNull Trigger trigger) throws Kap
             throw new KapuaIllegalNullArgumentException("interval");
         }
 
-        createQuartzTriggerWithSchedule(trigger, SimpleScheduleBuilder.repeatSecondlyForever(interval));
+        createQuartzTriggerWithSchedule(
+                trigger,
+                SimpleScheduleBuilder.repeatSecondlyForever(interval)
+                        .withMisfireHandlingInstructionFireNow() // This option force a misfired trigger to be always fired
+        );
     }
 
 
@@ -134,7 +138,12 @@ public static void createCronJobTrigger(@NotNull Trigger trigger) throws KapuaIl
             throw new KapuaIllegalNullArgumentException("cronExpression");
         }
 
-        createQuartzTriggerWithSchedule(trigger, CronScheduleBuilder.cronSchedule(cron).inTimeZone(TimeZone.getTimeZone("UTC")));
+        createQuartzTriggerWithSchedule(
+                trigger,
+                CronScheduleBuilder.cronSchedule(cron)
+                        .withMisfireHandlingInstructionFireAndProceed() // This option force a misfired trigger to be always fired
+                        .inTimeZone(TimeZone.getTimeZone("UTC"))
+        );
     }
 
     //
diff --git a/service/scheduler/quartz/src/main/resources/quartz.properties b/service/scheduler/quartz/src/main/resources/quartz.properties
index c88452cbfb3..4309580b5d3 100644
--- a/service/scheduler/quartz/src/main/resources/quartz.properties
+++ b/service/scheduler/quartz/src/main/resources/quartz.properties
@@ -22,6 +22,11 @@ org.quartz.jobStore.tablePrefix=SCHDL_QRTZ_
 
 org.quartz.dataSource.quartzDataSource.connectionProvider.class=org.eclipse.kapua.service.scheduler.quartz.persistence.KapuaQuartzConnectionProvider
 
+#
+# Trigger monitoring
+org.quartz.scheduler.idleWaitTime=10000
+org.quartz.jobStore.misfireThreshold=15000
+
 #
 # Plugins
 
