From bdc61c4853ffce1d3a1f075e2a67c9e8b0913071 Mon Sep 17 00:00:00 2001
From: ct-ajovanovic <aleksandra.jovanovic@comtrade.com>
Date: Fri, 7 Sep 2018 12:30:08 +0200
Subject: [PATCH 1/2] Unable To Save New Settings fix

Signed-off-by: ct-ajovanovic <aleksandra.jovanovic@comtrade.com>
---
 .../client/toolbar/AccountAddDialog.java        |  1 +
 .../client/toolbar/AccountEditDialog.java       | 17 +++++++++++++++++
 .../account/internal/AccountServiceImpl.java    |  5 ++++-
 3 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountAddDialog.java b/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountAddDialog.java
index f4cefb5bd28..3732b827db2 100644
--- a/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountAddDialog.java
+++ b/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountAddDialog.java
@@ -303,6 +303,7 @@ public void submit() {
         gwtAccountCreator.setOrganizationZipPostCode(organizationZipPostCode.getValue());
         gwtAccountCreator.setOrganizationStateProvinceCounty(organizationStateProvinceCounty.getValue());
         gwtAccountCreator.setOrganizationCountry(organizationCountry.getValue());
+        gwtAccountCreator.setScopeId(currentSession.getSelectedAccountId());
 
         GWT_ACCOUNT_SERVICE.create(xsrfToken,
                 gwtAccountCreator,
diff --git a/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountEditDialog.java b/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountEditDialog.java
index 51f36c7f810..0374c6ae069 100644
--- a/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountEditDialog.java
+++ b/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountEditDialog.java
@@ -47,6 +47,23 @@ protected void onRender(Element parent, int pos) {
         accountNameLabel.setValue(selectedAccount.getName());
         accountNameField.setValue(selectedAccount.getName());
 
+        if (selectedAccount.getParentAccountId() != null) {
+            GWT_ACCOUNT_SERVICE.find(selectedAccount.getParentAccountId(), new AsyncCallback<GwtAccount>() {
+
+                @Override
+                public void onSuccess(GwtAccount result) {
+                    if (parentAccountNameLabel != null) {
+                        parentAccountNameLabel.setValue(result.getName());
+                    }
+                }
+
+                @Override
+                public void onFailure(Throwable caught) {
+                    caught.printStackTrace();
+                }
+            });
+        }      
+
         expirationDateField.setValue(selectedAccount.getExpirationDate());
         expirationDateField.setOriginalValue(selectedAccount.getExpirationDate());
 
diff --git a/service/account/internal/src/main/java/org/eclipse/kapua/service/account/internal/AccountServiceImpl.java b/service/account/internal/src/main/java/org/eclipse/kapua/service/account/internal/AccountServiceImpl.java
index 8e4d1ae747f..c9c513f1e30 100644
--- a/service/account/internal/src/main/java/org/eclipse/kapua/service/account/internal/AccountServiceImpl.java
+++ b/service/account/internal/src/main/java/org/eclipse/kapua/service/account/internal/AccountServiceImpl.java
@@ -151,6 +151,7 @@ public Account update(Account account) throws KapuaException {
         ArgumentValidator.notEmptyOrNull(account.getName(), "account.name");
         ArgumentValidator.notNull(account.getOrganization(), "account.organization");
         ArgumentValidator.match(account.getOrganization().getEmail(), CommonsValidationRegex.EMAIL_REGEXP, "account.organization.email");
+        Account parentAccount = null;
 
         //
         // Check Access
@@ -170,7 +171,9 @@ public Account update(Account account) throws KapuaException {
         }
 
         // check that expiration date is no later than parent expiration date
-        Account parentAccount = KapuaSecurityUtils.doPrivileged(() -> find(oldAccount.getScopeId()));
+        if (oldAccount.getScopeId() != null) {
+            parentAccount = KapuaSecurityUtils.doPrivileged(() -> find(oldAccount.getScopeId()));
+        }
         if (parentAccount != null && parentAccount.getExpirationDate() != null) {
             // if parent account never expires no check is needed
             if (account.getExpirationDate() == null || parentAccount.getExpirationDate().before(account.getExpirationDate())) {

From d74717e277da73de47b1a92e17a3b6bf1fd72a59 Mon Sep 17 00:00:00 2001
From: ct-ajovanovic <aleksandra.jovanovic@comtrade.com>
Date: Mon, 10 Sep 2018 12:53:53 +0200
Subject: [PATCH 2/2] Made requested changes on AccountEditDialog and
 AccountServiceImpl classes

Signed-off-by: ct-ajovanovic <aleksandra.jovanovic@comtrade.com>
---
 .../module/account/client/toolbar/AccountEditDialog.java        | 2 +-
 .../kapua/service/account/internal/AccountServiceImpl.java      | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountEditDialog.java b/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountEditDialog.java
index 0374c6ae069..9d8a49aa2ad 100644
--- a/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountEditDialog.java
+++ b/console/module/account/src/main/java/org/eclipse/kapua/app/console/module/account/client/toolbar/AccountEditDialog.java
@@ -59,7 +59,7 @@ public void onSuccess(GwtAccount result) {
 
                 @Override
                 public void onFailure(Throwable caught) {
-                    caught.printStackTrace();
+                    FailureHandler.handle(caught);
                 }
             });
         }      
diff --git a/service/account/internal/src/main/java/org/eclipse/kapua/service/account/internal/AccountServiceImpl.java b/service/account/internal/src/main/java/org/eclipse/kapua/service/account/internal/AccountServiceImpl.java
index c9c513f1e30..fe12e9bf25d 100644
--- a/service/account/internal/src/main/java/org/eclipse/kapua/service/account/internal/AccountServiceImpl.java
+++ b/service/account/internal/src/main/java/org/eclipse/kapua/service/account/internal/AccountServiceImpl.java
@@ -151,7 +151,6 @@ public Account update(Account account) throws KapuaException {
         ArgumentValidator.notEmptyOrNull(account.getName(), "account.name");
         ArgumentValidator.notNull(account.getOrganization(), "account.organization");
         ArgumentValidator.match(account.getOrganization().getEmail(), CommonsValidationRegex.EMAIL_REGEXP, "account.organization.email");
-        Account parentAccount = null;
 
         //
         // Check Access
@@ -171,6 +170,7 @@ public Account update(Account account) throws KapuaException {
         }
 
         // check that expiration date is no later than parent expiration date
+        Account parentAccount = null;
         if (oldAccount.getScopeId() != null) {
             parentAccount = KapuaSecurityUtils.doPrivileged(() -> find(oldAccount.getScopeId()));
         }
