From b1b04a50738fa30b267e48ec37bd68b63e48822a Mon Sep 17 00:00:00 2001
From: Aleksandra Jovanovic <aleksandra.jovanovic@comtrade.com>
Date: Wed, 15 May 2019 09:55:30 +0200
Subject: [PATCH] Fix for String Channel values not displayed correctly

Signed-off-by: Aleksandra Jovanovic <aleksandra.jovanovic@comtrade.com>
---
 .../module/api/client/util/KapuaSafeHtmlUtils.java    | 11 +++++++----
 .../client/device/assets/DeviceAssetsPanel.java       |  6 +++---
 2 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/console/module/api/src/main/java/org/eclipse/kapua/app/console/module/api/client/util/KapuaSafeHtmlUtils.java b/console/module/api/src/main/java/org/eclipse/kapua/app/console/module/api/client/util/KapuaSafeHtmlUtils.java
index 7e06e2ecd43..c0579e50285 100644
--- a/console/module/api/src/main/java/org/eclipse/kapua/app/console/module/api/client/util/KapuaSafeHtmlUtils.java
+++ b/console/module/api/src/main/java/org/eclipse/kapua/app/console/module/api/client/util/KapuaSafeHtmlUtils.java
@@ -1,5 +1,5 @@
 /*******************************************************************************
- * Copyright (c) 2017 Eurotech and/or its affiliates and others
+ * Copyright (c) 2017, 2019 Eurotech and/or its affiliates and others
  *
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
@@ -30,6 +30,12 @@ public static String htmlUnescape(String safeHtml) {
             return null;
         }
 
+        if (safeHtml.indexOf("&amp;") != -1) {
+            safeHtml = safeHtml.replace("&amp;", "&");
+        }
+        if (safeHtml.indexOf("amp;") != -1) {
+            safeHtml = safeHtml.replace("amp;","");
+        }
         if (safeHtml.indexOf("&lt;") != -1) {
             safeHtml = safeHtml.replace("&lt;", "<");
         }
@@ -42,9 +48,6 @@ public static String htmlUnescape(String safeHtml) {
         if (safeHtml.indexOf("&#39;") != -1) {
             safeHtml = safeHtml.replace("&#39;", "'");
         }
-        if (safeHtml.indexOf("&amp;") != -1) {
-            safeHtml = safeHtml.replace("&amp;", "&");
-        }
         return safeHtml;
     }
 }
diff --git a/console/module/device/src/main/java/org/eclipse/kapua/app/console/module/device/client/device/assets/DeviceAssetsPanel.java b/console/module/device/src/main/java/org/eclipse/kapua/app/console/module/device/client/device/assets/DeviceAssetsPanel.java
index 9a93a75897b..9ba2a2cda7e 100644
--- a/console/module/device/src/main/java/org/eclipse/kapua/app/console/module/device/client/device/assets/DeviceAssetsPanel.java
+++ b/console/module/device/src/main/java/org/eclipse/kapua/app/console/module/device/client/device/assets/DeviceAssetsPanel.java
@@ -18,6 +18,7 @@
 import org.eclipse.kapua.app.console.module.device.client.messages.ConsoleDeviceMessages;
 import org.eclipse.kapua.app.console.module.api.client.util.Constants;
 import org.eclipse.kapua.app.console.module.api.client.util.FormUtils;
+import org.eclipse.kapua.app.console.module.api.client.util.KapuaSafeHtmlUtils;
 import org.eclipse.kapua.app.console.module.api.client.util.UserAgentUtils;
 import org.eclipse.kapua.app.console.module.api.shared.model.session.GwtSession;
 import org.eclipse.kapua.app.console.module.device.shared.model.device.management.assets.GwtDeviceAsset;
@@ -282,15 +283,14 @@ public void handleEvent(BaseEvent be) {
 
         TextField<String> field = new TextField<String>();
         field.setName(channel.getName());
-        field.setValue((String) channel.getValue());
         field.setAllowBlank(true);
         field.setFieldLabel(channel.getName() + " (" + channel.getType() + " - " + channel.getMode() + ")");
         field.setLabelStyle("word-break:break-all");
         field.addPlugin(dirtyPlugin);
 
         if (channel.getValue() != null) {
-            field.setValue((String) channel.getValue());
-            field.setOriginalValue((String) channel.getValue());
+            field.setValue(KapuaSafeHtmlUtils.htmlUnescape((String) channel.getValue()));
+            field.setOriginalValue(KapuaSafeHtmlUtils.htmlUnescape((String) channel.getValue()));
         }
         return field;
     }
